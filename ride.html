<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bykea - Ride Booking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- Shared Variables & Global Reset --- */
        :root {
            /* Bykea Brand Colors */
            --color-text: #313131; /* Dark grey (Mine Shaft) */
            --color-bg: #ffffff; /* White background */
            --color-ride: #02aa31; /* Bykea Green (Green Haze) */
            --color-border: #757575;
            --color-success: #02aa31; /* Bykea green for success states */
            --color-highlight: #E8F5E9; /* Light green highlight */
            --color-card-bg: #FFFFFF;

            /* High Contrast Colors */
            --hc-bg: #000000;
            --hc-text: #FFFFFF;
            --hc-card-bg: #222222;
            --hc-border: #AAAAAA;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            border: 4px solid #000000;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 0;
            min-height: 100vh;
            box-sizing: border-box;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Ensure all child elements respect container width */
        .app-container * {
            box-sizing: border-box;
        }

        /* RTL/LTR Handling */
        [dir="rtl"] { text-align: right; }
        [dir="ltr"] { text-align: left; }

        /* Large Touch Targets Base */
        button, input, textarea {
            min-height: 48px;
            cursor: pointer;
            box-sizing: border-box;
        }

        /* ========================================= */
        /* === ACCESSIBILITY SCALING (GLOBAL) - HIGH CONTRAST === */
        /* ========================================= */
        .mode-accessible { 
            font-size: 1.25rem; 
            background-color: #ffffff !important; /* White background */
            color: var(--color-text) !important;
        }
        .mode-accessible body {
            background-color: #ffffff !important; /* White background */
            color: var(--color-text) !important;
        }
        .mode-accessible h1, .mode-accessible h2, .mode-accessible h3, .mode-accessible h4 { 
            color: var(--color-text) !important;
        }

        /* Scale Inputs/Labels/Paddings */
        .mode-accessible .input-group label,
        .mode-accessible .summary-label { 
            font-size: 1.5rem; 
        }
        .mode-accessible input { 
            font-size: 1.4rem; 
            padding: 1.25rem; 
            background-color: #ffffff; 
            color: var(--color-text);
            border: 3px solid var(--color-text);
        }

        /* Scale Buttons/Items */
        .mode-accessible .location-item { 
            font-size: 1.4rem; 
            padding: 1.25rem 1.5rem; 
            background-color: #ffffff;
            border: 3px solid var(--color-text);
            color: var(--color-text);
        }
        .mode-accessible .recent-locations-container {
            border-top: 3px solid var(--hc-border);
            border-bottom: 3px solid var(--hc-border);
        }
        .mode-accessible .cat-icon { font-size: 4rem; } 
        .mode-accessible .cat-card {
            background-color: #ffffff;
            border: 3px solid var(--color-text);
        }
        .mode-accessible .cat-card.selected { 
            background-color: #015a1f; /* Dark Bykea green */
            border-color: var(--color-ride);
        }
        
        /* Offers */
        .mode-accessible .offer-card { 
            background: var(--hc-card-bg); 
            border: 3px solid var(--hc-border);
        }
        .mode-accessible .offer-details h4 { font-size: 1.5rem; } 
        .mode-accessible .offer-details p { font-size: 1.15rem; color: var(--hc-border); } 
        .mode-accessible .offer-price { font-size: 1.8rem; } 

        /* Summary */
        .mode-accessible .summary-box {
            background: #ffffff;
            border: 3px solid var(--color-text);
        }
        .mode-accessible .pay-option { 
            font-size: 1.8rem; 
            padding: 1.25rem; 
            background: #ffffff;
            border: 3px solid var(--color-text);
            color: var(--color-text);
        }
        .mode-accessible .pay-option.selected { 
            background-color: #015a1f; /* Dark Bykea green */
            border-color: var(--color-success);
        }
        
        /* Scale Action Buttons */
        .mode-accessible .action-button { 
            font-size: 1.8rem; 
            padding: 1.25rem; 
            font-weight: 800; 
        }
        /* ========================================= */


        /* --- Header & Navigation --- */
        .app-header {
            padding: 0;
            margin: 0;
            text-align: center;
            position: relative;
            border-bottom: 1px solid #eee;
            margin-bottom: 1rem;
        }
        
        /* Add spacing after logo */
        .app-title {
            margin-top: 1.5rem;
        }
        
        /* Progress Stepper */
        .progress-stepper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            margin: 1rem 0;
            position: relative;
            --progress-percent: 0;
        }
        
        .progress-stepper::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #d0d0d0;
            z-index: 0;
            transform: translateY(-50%);
        }
        
        .progress-stepper::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            height: 2px;
            background: var(--color-ride);
            z-index: 1;
            transform: translateY(-50%);
            transition: width 0.3s ease;
            width: calc((var(--progress-percent) / 100) * 80%);
        }
        
        .step-indicator {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 33.33%;
        }
        
        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            border: 2px solid #d0d0d0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: #666;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }
        
        .step-indicator.completed .step-circle {
            background: var(--color-ride);
            border-color: var(--color-ride);
            color: white;
        }
        
        .step-indicator.active .step-circle {
            background: var(--color-ride);
            border-color: var(--color-ride);
            color: white;
            box-shadow: 0 0 0 4px rgba(2, 170, 49, 0.2);
        }
        
        .step-label {
            margin-top: 0.5rem;
            font-size: 0.65rem;
            color: #666;
            text-align: center;
            font-weight: 500;
            line-height: 1.2;
        }
        
        .step-indicator.completed .step-label,
        .step-indicator.active .step-label {
            color: var(--color-ride);
            font-weight: 600;
        }
        
        .mode-accessible .step-circle {
            width: 40px;
            height: 40px;
            font-size: 1.1rem;
            border-width: 3px;
        }
        
        .mode-accessible .step-label {
            font-size: 0.9rem;
            margin-top: 0.75rem;
        }
        
        .mode-accessible .progress-stepper::before,
        .mode-accessible .progress-stepper::after {
            height: 3px;
        }
        
        /* Add horizontal padding to content */
        main#main-content,
        .app-title {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .mode-accessible .app-header {
            border-bottom: 3px solid var(--hc-border);
        }
        .app-logo {
            width: 100%;
            height: auto;
            max-height: none;
            object-fit: contain;
            display: block;
            margin: 0;
            padding: 0;
        }
        .mode-accessible .app-logo {
            height: auto;
        }
        .app-title { font-weight: 800; margin: 0; }
        .mode-standard .app-title { font-size: 1.25rem; }
        
        .back-button {
            position: relative;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--color-ride);
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            z-index: 10;
        }
        [dir='ltr'] .back-button { 
            flex-direction: row; 
            margin-left: 1rem;
            margin-right: auto;
        }
        [dir='rtl'] .back-button { 
            flex-direction: row-reverse; 
            margin-right: 1rem;
            margin-left: auto;
        }
        .back-icon { font-size: 1.5rem; margin: 0; }

        /* --- Wizard Step Views --- */
        .step-view { display: none; animation: fadeIn 0.3s ease; }
        .step-view.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Step 1: Location & Category Styles --- */
        .map-placeholder {
            width: 100%;
            height: 200px;
            background-color: #E0E0E0;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #757575;
            font-weight: bold;
        }
        .mode-accessible .map-placeholder {
            background-color: #f0f0f0;
            color: var(--color-text);
        }

        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        input { 
            width: 100%; border: 2px solid var(--color-border); 
            border-radius: 4px; padding: 0.75rem;
        }
        
        /* Highlight focused input */
        input.focused {
            border-color: var(--color-ride) !important;
            box-shadow: 0 0 0 2px #F8BBD0; 
        }

        /* --- RECENT LOCATIONS STYLES --- */
        .recent-locations-container {
            padding: 1rem 0;
            border-top: 1px solid #E0E0E0;
            border-bottom: 1px solid #E0E0E0;
            margin-bottom: 1rem;
        }

        .recent-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .recent-list {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto; 
            padding-bottom: 0.5rem;
        }

        .location-item {
            flex-shrink: 0; 
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #EFEFEF;
            border: 1px solid #ddd;
            border-radius: 9999px; 
            padding: 0.75rem 1rem;
            white-space: nowrap;
            font-weight: 500;
            transition: background 0.2s, color 0.2s;
        }
        .mode-accessible .location-item {
            background: var(--hc-card-bg);
            border: 3px solid var(--hc-border);
            color: var(--hc-text);
        }

        .location-item:hover {
            background: #e0e0e0;
        }

        /* --- Vehicle Category Styles --- */
        .category-grid { display: flex; gap: 0.5rem; justify-content: space-between; margin-bottom: 1.5rem; }
        .cat-card {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            padding: 0.75rem; border: 2px solid var(--color-border);
            border-radius: 8px; background: white; transition: 0.2s;
        }
        .cat-card.selected { border-color: var(--color-ride); background-color: var(--color-highlight); }
        .cat-icon { font-size: 2.5rem; margin-bottom: 0.25rem; }

        /* --- Step 2: Offers List Styles --- */
        .offers-list { display: flex; flex-direction: column; gap: 1rem; }
        .offer-card {
            display: flex; align-items: center; justify-content: space-between;
            padding: 1rem; border: 1px solid #ddd; border-radius: 8px;
            background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .offer-card:hover { border-color: var(--color-ride); }
        
        .offer-left { display: flex; align-items: center; gap: 1rem; }
        .driver-avatar { 
            width: 50px; height: 50px; background: #eee; 
            border-radius: 50%; display: grid; place-items: center; font-size: 1.5rem;
        }
        .offer-details { 
            min-width: 150px; 
        }
        .offer-details h4 { margin: 0; font-size: 1.1rem; }
        .offer-details p { 
            margin: 0; color: #666; font-size: 0.9rem; 
            line-height: 1.2;
        }
        .offer-details .vehicle-info { 
            font-size: 0.9rem; font-weight: 600; color: #424242; 
        }

        .offer-price { font-weight: 800; color: var(--color-ride); font-size: 1.25rem; }

        /* --- Step 3: Payment Styles --- */
        .summary-box {
            background: var(--color-highlight); border: 1px solid #ddd;
            padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;
        }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .summary-label { font-weight: 600; }
        
        .payment-options { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 2rem; }
        .pay-option {
            display: flex; align-items: center; gap: 1rem; padding: 1rem;
            border: 2px solid var(--color-border); border-radius: 8px; font-weight: 600;
        }
        .pay-option.selected { border-color: var(--color-success); background-color: #E8F5E9; }

        /* --- Global Action Button --- */
        .action-button {
            width: 100%; color: white; border: none; border-radius: 8px;
            font-weight: 700; background-color: var(--color-ride);
            margin-top: 1rem;
            font-size: 1.1rem; padding: 0.75rem; /* Standard default */
        }

        /* --- Modal (S4) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 12px;
            width: 90%; max-width: 400px; text-align: center; border: 4px solid var(--color-success);
        }
        .mode-accessible .modal-content {
            background: #ffffff;
            color: var(--color-text);
        }
        .mode-accessible .modal-content h3 { color: var(--color-success) !important; }
    </style>
</head>
<body>
    <div class="app-container" id="app-container">

        <header class="app-header">
            <img src="logoUrdu.jpeg" alt="Bykea" class="app-logo" id="app-logo">
            <button class="back-button" id="global-back-btn" onclick="handleBack(event)">
                <span class="back-icon">‚Üê</span>
            </button>
            <h1 class="app-title" id="page-title">ÿ≥Ÿàÿßÿ±€å ÿ®⁄© ⁄©ÿ±€å⁄∫</h1>
            <div class="progress-stepper" id="progress-stepper" role="progressbar" aria-valuenow="1" aria-valuemin="1" aria-valuemax="3" aria-label="Booking progress">
                <div class="step-indicator" data-step="1">
                    <div class="step-circle">1</div>
                    <span class="step-label" id="step-label-1">Location</span>
                </div>
                <div class="step-indicator" data-step="2">
                    <div class="step-circle">2</div>
                    <span class="step-label" id="step-label-2">Driver</span>
                </div>
                <div class="step-indicator" data-step="3">
                    <div class="step-circle">3</div>
                    <span class="step-label" id="step-label-3">Summary</span>
                </div>
            </div>
        </header>

        <main id="main-content">
            
            <div id="step-1" class="step-view active">
                <div class="map-placeholder" id="txt-map" onclick="speakText('Map view showing current location and destination.')">ŸÜŸÇÿ¥€Å €å€Åÿß⁄∫ €Å€í</div>
                
                <div class="input-group">
                    <label id="lbl-pickup">ÿßŸπ⁄æÿßŸÜ€í ⁄©ÿß ŸÖŸÇÿßŸÖ</label>
                    <input type="text" id="inp-pickup" value="Current Location" onclick="speakInputElement(this)">
                </div>
                <div class="input-group">
                    <label id="lbl-dropoff">ŸÖŸÜÿ≤ŸÑ</label>
                    <input type="text" id="inp-dropoff" placeholder="ŸÖŸÜÿ≤ŸÑ ÿØÿ±ÿ¨ ⁄©ÿ±€å⁄∫" onclick="speakInputElement(this)">
                </div>

                <div class="recent-locations-container">
                    <h4 id="lbl-recent" class="recent-title">ÿ≠ÿßŸÑ€å€Å ŸÖŸÇÿßŸÖÿßÿ™</h4>
                    <div class="recent-list" id="recent-list">
                        </div>
                </div>
                <h3 id="lbl-cat-select" style="margin-top: 1.5rem;">⁄Øÿß⁄ë€å ⁄©€å ŸÇÿ≥ŸÖ</h3>
                <div class="category-grid" id="cat-grid">
                        </div>

                <button class="action-button" id="btn-next-1" onclick="goToStep2(event)">ÿß⁄ØŸÑÿß (Next)</button>
            </div>

            <div id="step-2" class="step-view">
                <h3 id="lbl-offers">ÿØÿ≥ÿ™€åÿßÿ® ÿ¢ŸÅÿ±ÿ≤</h3>
                <p id="lbl-offers-sub" style="margin-top:-10px; color:#666;">⁄àÿ±ÿßÿ¶€åŸàÿ± ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±€å⁄∫</p>
                
                <div class="offers-list" id="offers-list">
                        </div>
            </div>

            <div id="step-3" class="step-view">
                <h3 id="lbl-summary">ÿ≥ŸÅÿ± ⁄©ÿß ÿÆŸÑÿßÿµ€Å</h3>
                
                <div class="summary-box">
                    <div class="summary-row">
                        <span class="summary-label" id="lbl-vehicle">⁄Øÿß⁄ë€å:</span>
                        <span id="sum-vehicle">...</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label" id="lbl-est-price">ŸÇ€åŸÖÿ™:</span>
                        <span id="sum-price" style="color: var(--color-ride); font-weight:bold;">...</span>
                    </div>
                </div>

                <h3 id="lbl-payment">ÿßÿØÿßÿ¶€å⁄Ø€å ⁄©ÿß ÿ∑ÿ±€åŸÇ€Å</h3>
                <div class="payment-options">
                    <button class="pay-option selected" onclick="selectPayment(this, 'cash', event)">
                        <span>üíµ</span> <span id="pay-cash">ŸÜŸÇÿØ (Cash)</span>
                    </button>
                    <button class="pay-option" onclick="selectPayment(this, 'wallet', event)">
                        <span>üí≥</span> <span id="pay-wallet">ŸàÿßŸÑŸπ (Wallet)</span>
                    </button>
                </div>

                <button class="action-button" id="btn-book" onclick="showModal(event)">ÿ®⁄© ⁄©ÿ±€å⁄∫ (Book Now)</button>
            </div>

        </main>
        
        <div class="modal-overlay" id="modal">
            <div class="modal-content">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                <h3 id="modal-title" style="margin:0; font-size:1.5rem; color:var(--color-success);">ÿ®⁄©ŸÜ⁄Ø ⁄©ŸÜŸÅÿ±ŸÖ!</h3>
                <p id="modal-msg">⁄àÿ±ÿßÿ¶€åŸàÿ± ÿ¢Ÿæ ⁄©€å ÿ∑ÿ±ŸÅ ÿ¢ ÿ±€Åÿß €Å€í€î</p>
                <button class="action-button" style="background:var(--color-success);" onclick="window.location.href='confirmation.html'" id="modal-ok">Ÿπ⁄æ€å⁄© €Å€í</button>
            </div>
        </div>

    </div>

    <script>
        /* --- LOCALIZATION DATA --- */
        const TEXTS = {
            back: { ur: "Ÿæ€å⁄Ü⁄æ€í ÿ¨ÿßÿ¶€å⁄∫", en: "Back" },
            title1: { ur: "ÿ≥Ÿàÿßÿ±€å ÿ®⁄© ⁄©ÿ±€å⁄∫", en: "Book a Ride" },
            title2: { ur: "⁄àÿ±ÿßÿ¶€åŸàÿ± ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±€å⁄∫", en: "Select Driver" },
            title3: { ur: "ÿßÿØÿßÿ¶€å⁄Ø€å ÿßŸàÿ± ÿ™ÿµÿØ€åŸÇ", en: "Payment & Confirm" },
            
            // Progress Stepper Labels
            stepLabel1: { ur: "ŸÖŸÇÿßŸÖ", en: "Location" },
            stepLabel2: { ur: "⁄àÿ±ÿßÿ¶€åŸàÿ±", en: "Driver" },
            stepLabel3: { ur: "ÿÆŸÑÿßÿµ€Å", en: "Summary" },
            
            // Step 1
            map: { ur: "ŸÜŸÇÿ¥€Å €å€Åÿß⁄∫ €Å€í", en: "Map View" },
            lblPickup: { ur: "ÿßŸπ⁄æÿßŸÜ€í ⁄©ÿß ŸÖŸÇÿßŸÖ", en: "Pickup Location" },
            lblDropoff: { ur: "ŸÖŸÜÿ≤ŸÑ", en: "Destination" },
            phDropoff: { ur: "ŸÖŸÜÿ≤ŸÑ ÿØÿ±ÿ¨ ⁄©ÿ±€å⁄∫", en: "Enter Destination" },
            lblCat: { ur: "⁄Øÿß⁄ë€å ⁄©€å ŸÇÿ≥ŸÖ", en: "Vehicle Type" },
            btnNext: { ur: "ÿ¢ŸÅÿ±ÿ≤ ÿØ€å⁄©⁄æ€å⁄∫", en: "See Offers" },
            lblRecent: { ur: "ÿ≠ÿßŸÑ€å€Å ŸÖŸÇÿßŸÖÿßÿ™", en: "Recent Locations" },
            recentLocations: [
                { ur: "⁄©ŸÑŸÅŸπŸÜ", en: "Clifton", address: "Clifton Park" },
                { ur: "⁄à€åŸÅŸÜÿ≥ €Åÿßÿ§ÿ≥ŸÜ⁄Ø ÿßÿ™⁄æÿßÿ±Ÿπ€å", en: "DHA Phase V", address: "DHA Phase V Block B" },
                { ur: "ÿµÿØÿ± ÿ®ÿßÿ≤ÿßÿ±", en: "Saddar Bazaar", address: "Saddar Main Market" }
            ],

            // Step 2
            lblOffers: { ur: "ÿØÿ≥ÿ™€åÿßÿ® ÿ¢ŸÅÿ±ÿ≤", en: "Available Offers" },
            lblOffersSub: { ur: "ÿ®€Åÿ™ÿ±€åŸÜ ÿ¢Ÿæÿ¥ŸÜ ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±€å⁄∫", en: "Select best option" },
            
            // Step 3
            lblSummary: { ur: "ÿ≥ŸÅÿ± ⁄©ÿß ÿÆŸÑÿßÿµ€Å", en: "Trip Summary" },
            lblVehicle: { ur: "⁄Øÿß⁄ë€å:", en: "Vehicle:" },
            lblEstPrice: { ur: "ŸÇ€åŸÖÿ™:", en: "Price:" },
            lblPayment: { ur: "ÿßÿØÿßÿ¶€å⁄Ø€å ⁄©ÿß ÿ∑ÿ±€åŸÇ€Å", en: "Payment Method" },
            payCash: { ur: "ŸÜŸÇÿØ", en: "Cash" },
            payWallet: { ur: "⁄©ÿ±€å⁄àŸπ ⁄©ÿßÿ±⁄à / ŸàÿßŸÑŸπ", en: "Card / Wallet" },
            btnBook: { ur: "ÿ®⁄© ⁄©ÿ±€å⁄∫", en: "Book Now" },

            // Modal
            modalTitle: { ur: "ÿ®⁄©ŸÜ⁄Ø ⁄©ŸÜŸÅÿ±ŸÖ!", en: "Booking Confirmed!" },
            modalMsg: { ur: "⁄àÿ±ÿßÿ¶€åŸàÿ± ÿ¢Ÿæ ⁄©€å ÿ∑ÿ±ŸÅ ÿ¢ ÿ±€Åÿß €Å€í€î", en: "Driver is coming." },
            modalOk: { ur: "Ÿπ⁄æ€å⁄© €Å€í", en: "OK" },

            // Data
            cats: [
                { id: 'bike', ur: 'ŸÖŸàŸπÿ± ÿ≥ÿßÿ¶€å⁄©ŸÑ', en: 'Bike', icon: 'üèçÔ∏è' },
                { id: 'rickshaw', ur: 'ÿ±⁄©ÿ¥€Å', en: 'Rickshaw', icon: 'üõ∫' },
                { id: 'car', ur: '⁄Øÿß⁄ë€å', en: 'Car', icon: 'üöò' }
            ],
            
            voicePrompt: { ur: "ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±ÿØ€Å ", en: "Selected " },
            voiceErrorRequired: { ur: "ÿÆÿ±ÿßÿ®€å: ÿ®ÿ±ÿß€Å ⁄©ÿ±ŸÖ Ÿæ⁄© ÿßŸæ ÿßŸàÿ± ŸÖŸÜÿ≤ŸÑ ÿØŸàŸÜŸà⁄∫ ÿØÿ±ÿ¨ ⁄©ÿ±€å⁄∫€î", en: "Error: Please enter both pickup and destination." },
        };

        /* --- STATE --- */
        let currentStep = 1;
        let selectedCat = 'bike';
        let selectedOffer = null; 
        let currentLang = localStorage.getItem('appLang') || 'ur';
        // Setting default mode to 'accessible' as per the request's context suggests accessibility focus
        let currentMode = localStorage.getItem('appMode') || 'standard'; // Default: Standard (white background) 
        let currentInputFocus = 'dropoff'; 

        /* --- DOM ELEMENTS --- */
        const els = {
            container: document.getElementById('app-container'),
            step1: document.getElementById('step-1'),
            step2: document.getElementById('step-2'),
            step3: document.getElementById('step-3'),
            backBtn: document.getElementById('global-back-btn'),
            pageTitle: document.getElementById('page-title'),
            catGrid: document.getElementById('cat-grid'),
            offersList: document.getElementById('offers-list'),
            btnNext1: document.getElementById('btn-next-1'),
            btnBook: document.getElementById('btn-book'),
            modal: document.getElementById('modal'),
            recentList: document.getElementById('recent-list'),
            inpPickup: document.getElementById('inp-pickup'),
            inpDropoff: document.getElementById('inp-dropoff'),
            sumVehicle: document.getElementById('sum-vehicle'),
            sumPrice: document.getElementById('sum-price'),
        };
        
        // TTS Initialization
        const synth = window.speechSynthesis;
        let voices = [];
        if (synth) {
            synth.onvoiceschanged = () => { voices = synth.getVoices(); };
            synth.onvoiceschanged(); 
        }

        /**
         * Performs navigation (SPA or MPA)
         * (Assumes it's being called after TTS finishes in accessible mode).
         */
        function performNavigation(target, isMPA = false, callback = null) {
            const navigate = () => {
                if (isMPA) {
                    // This handles the final booking or back to home which is outside the SPA flow
                    window.location.href = target;
                } else {
                    // This handles the SPA step navigation (1 -> 2 -> 3)
                    currentStep = target;
                    // Update progress stepper immediately before switchView
                    updateProgressStepper();
                    switchView();
                }
                if (callback) callback();
            };

            // Execute immediately. If in accessible mode, the caller (speakText.onend) controls the timing.
            navigate();
        }

        /**
         * Converts text to speech. Can accept a callback function to run on speech end.
         */
        function speakText(text, callback = null) {
            if (!synth || currentMode !== 'accessible') {
                if (callback) setTimeout(callback, 50); // Execute callback quickly if no speech
                return;
            }
            synth.cancel();

            if (voices.length === 0) voices = synth.getVoices();
            const utterance = new SpeechSynthesisUtterance(text);
            
            let langCode = currentLang === 'ur' ? 'ur-PK' : 'en-US';
            const voice = voices.find(v => v.lang.startsWith(langCode.substring(0, 2))); 
            if (voice) utterance.voice = voice;
            else utterance.lang = langCode;

            utterance.rate = 1.0; 
            
            if (callback) {
                // IMPORTANT: Ensure navigation is called only upon successful speech end
                utterance.onend = callback;
                // Consider adding onerror to handle failure cases gracefully if needed
                // utterance.onerror = callback; 
            }
            
            synth.speak(utterance);
        }
        
        /**
         * Announces the label and content of an input element when clicked.
         */
        function speakInputElement(inputElement) {
             if (currentMode !== 'accessible') return;
             
             const label = inputElement.previousElementSibling;
             let labelText = label ? label.textContent : '';
             let content = inputElement.value || inputElement.placeholder;
             
             speakText(`${labelText}. Current value: ${content}.`);
        }
        
        /**
         * Global handler for clicks on non-interactive text elements.
         */
        function handleTextClick(event) {
             if (currentMode !== 'accessible') return;
             
             const target = event.target;
             
             // Only process if the target isn't already handled by another event (e.g., button, card, input)
             if (target.tagName === 'BUTTON' || target.closest('a') || target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.closest('.location-item') || target.closest('.cat-card') || target.closest('.pay-option') || target.closest('.offer-card')) {
                 return;
             }

             // Use the element itself or a close parent that contains the text
             const textToSpeak = target.textContent.trim();
             
             if (textToSpeak.length > 0) {
                 speakText(textToSpeak);
             }
        }


        /* --- INITIALIZATION --- */
        function init() {
            // Load persisted state
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ur' ? 'rtl' : 'ltr';
            els.container.className = `app-container mode-${currentMode}`;
            
            // Set initial state
            updateTexts();
            renderCategories();
            renderRecentLocations();
            switchView();

            // Event Listeners for inputs
            els.inpPickup.addEventListener('focus', () => updateInputFocus('pickup'));
            els.inpDropoff.addEventListener('focus', () => updateInputFocus('dropoff'));

            updateInputFocus('dropoff'); 
            
            // ** NEW: Global Click Listener for text reading **
            els.container.addEventListener('click', handleTextClick);

            // Initial Voice Announcement (delayed for stability)
            if (currentMode === 'accessible') {
                setTimeout(() => {
                    const titleKey = `title${currentStep}`;
                    speakText(TEXTS[titleKey][currentLang]);
                }, 800);
            }
        }

        /* --- LOGIC: INPUT FOCUS --- */
        function updateInputFocus(target) {
            currentInputFocus = target;
            els.inpPickup.classList.remove('focused');
            els.inpDropoff.classList.remove('focused');
            
            if (target === 'pickup') {
                els.inpPickup.classList.add('focused');
            } else if (target === 'dropoff') {
                els.inpDropoff.classList.add('focused');
            }
        }


        /* --- LOGIC: RENDERERS --- */
        function renderCategories() {
            els.catGrid.innerHTML = TEXTS.cats.map(cat => `
                <div class="cat-card ${cat.id === selectedCat ? 'selected' : ''}" 
                    onclick="selectCategory('${cat.id}', event)">
                    <div class="cat-icon">${cat.icon}</div>
                    <span style="font-weight:700">${cat[currentLang]}</span>
                </div>
            `).join('');
        }

        function renderRecentLocations() {
            els.recentList.innerHTML = TEXTS.recentLocations.map(loc => `
                <button class="location-item" 
                    data-address="${loc.address}" 
                    data-name="${loc[currentLang]}"
                    onclick="selectRecentLocation(this, event)">
                    <span>üìç</span>
                    <span>${loc[currentLang]}</span>
                </button>
            `).join('');
        }

        function generateOffers() {
            const catInfo = TEXTS.cats.find(c => c.id === selectedCat);
            const vehicleModel = catInfo.id === 'bike' ? 'Honda CG 125' : (catInfo.id === 'rickshaw' ? 'Qingqi' : 'Suzuki Cultus');
            const platePrefix = catInfo.id === 'bike' ? 'KHI-A' : (catInfo.id === 'rickshaw' ? 'LHR-R' : 'ISB-C');
            const basePrice = catInfo.id === 'bike' ? 150 : (catInfo.id === 'rickshaw' ? 250 : 400);
            
            const vehicles = [
                { name: 'Ali', rating: '4.9‚òÖ', time: '2 min', price: basePrice, model: vehicleModel, plate: `${platePrefix} 876` },
                { name: 'Ahmed', rating: '4.7‚òÖ', time: '5 min', price: basePrice - 20, model: vehicleModel, plate: `${platePrefix} 543` },
                { name: 'Bilal', rating: '5.0‚òÖ', time: '8 min', price: basePrice + 50, model: vehicleModel, plate: `${platePrefix} 210` }
            ];

            els.offersList.innerHTML = vehicles.map((v, index) => `
                <div class="offer-card" onclick="selectOffer(${index}, '${v.name}', ${v.price}, event, '${v.model}')">
                    <div class="offer-left">
                        <div class="driver-avatar">üë§</div>
                        <div class="offer-details">
                            <h4>${v.name} (${v.rating})</h4>
                            <p>${v.time} away</p>
                            <p class="vehicle-info">${v.model} (${v.plate})</p>
                        </div>
                    </div>
                    <div class="offer-price">Rs. ${v.price}</div>
                </div>
            `).join('');
        }
        
        function updateStep3Summary() {
              const catLabel = TEXTS.cats.find(c => c.id === selectedCat)[currentLang];
              els.sumVehicle.textContent = `${selectedOffer.vehicle || catLabel} (${selectedOffer.name})`;
              els.sumPrice.textContent = `PKR ${selectedOffer.price || 0}`;
        }

        /* --- LOGIC: ACTIONS (WITH VOICE) --- */
        function selectCategory(id, event) {
            const catLabel = event.currentTarget.querySelector('span').textContent;
            
            if (currentMode === 'accessible') {
                event.preventDefault();
                speakText(`${TEXTS.voicePrompt[currentLang]}${catLabel}.`);
            }
            selectedCat = id;
            renderCategories();
        }
        
        function selectRecentLocation(btn, event) {
            if (currentMode === 'accessible') {
                event.preventDefault();
            }
            const address = btn.getAttribute('data-name');
            
            const targetInput = currentInputFocus === 'pickup' ? els.inpPickup : els.inpDropoff;
            targetInput.value = address;
            
            if (currentMode === 'accessible') {
                const nextFocus = currentInputFocus === 'pickup' ? 'destination' : 'pickup';
                speakText(`${TEXTS.voicePrompt[currentLang]} ${address}. Now focus shifts to ${nextFocus} location.`);
            }
            
            if (currentInputFocus === 'pickup') {
                updateInputFocus('dropoff');
            } else {
                updateInputFocus('pickup');
            }
        }

        function selectOffer(index, name, price, event, model) {
            const catLabel = TEXTS.cats.find(c => c.id === selectedCat)[currentLang];
            selectedOffer = { name, price, vehicle: `${model} (${catLabel})` };
            
            const navigateToStep3 = () => performNavigation(3);

            if (currentMode === 'accessible') {
                event.preventDefault();
                speakText(`Offer selected. Driver ${name}, price ${price} rupees. Proceeding to payment.`, navigateToStep3);
            } else {
                navigateToStep3();
            }
        }
        
        function selectPayment(btn, type, event) {
             document.querySelectorAll('.pay-option').forEach(b => b.classList.remove('selected'));
             btn.classList.add('selected');
             
             if (currentMode === 'accessible') {
                 event.preventDefault();
                 const paymentMethod = btn.querySelector('span:last-child').textContent;
                 speakText(`Payment method set to ${paymentMethod}.`);
             }
        }

        function showModal(event) {
             const navigateToConfirmation = () => {
                 els.modal.style.display = 'flex';
                 // Use performNavigation for MPA jump
                 performNavigation('confirmation.html', true);
             };

             if (currentMode === 'accessible') {
                 event.preventDefault();
                 speakText(TEXTS.modalTitle[currentLang] + ". " + TEXTS.modalMsg[currentLang] + ". Going to confirmation screen.", navigateToConfirmation);
             } else {
                 navigateToConfirmation();
             }
        }
        
        /* --- LOGIC: NAVIGATION --- */
        function goToStep2(event) {
            const pickupSet = els.inpPickup.value.trim() !== '' && els.inpPickup.value.trim() !== 'Current Location';
            const dropoffSet = els.inpDropoff.value.trim() !== '' && els.inpDropoff.value.trim() !== TEXTS.phDropoff[currentLang];
            
            if (!pickupSet || !dropoffSet) {
                 if (currentMode === 'accessible') {
                     event.preventDefault();
                     speakText(TEXTS.voiceErrorRequired[currentLang]);
                 } else {
                     alert(currentLang === 'ur' ? 'ÿ®ÿ±ÿß€Å ⁄©ÿ±ŸÖ Ÿæ⁄© ÿßŸæ ÿßŸàÿ± ŸÖŸÜÿ≤ŸÑ ÿØŸàŸÜŸà⁄∫ ÿØÿ±ÿ¨ ⁄©ÿ±€å⁄∫€î' : 'Please enter both pickup and destination.');
                 }
                 return;
            }
            
            const navigateToStep2 = () => performNavigation(2);

            if (currentMode === 'accessible') {
                 event.preventDefault();
                 speakText(TEXTS.btnNext[currentLang] + ". Loading available offers.", navigateToStep2);
            } else {
                navigateToStep2();
            }
        }

        function handleBack(event) {
            if (currentStep === 1) {
                const navigateToHome = () => performNavigation('index.html', true);
                
                if (currentMode === 'accessible') {
                    event.preventDefault();
                    speakText(TEXTS.back[currentLang] + " to main menu.", navigateToHome);
                } else {
                    navigateToHome();
                }
            } else {
                currentStep--;
                const titleKey = `title${currentStep}`;
                
                const navigateBack = () => {
                    // Update progress stepper immediately before switchView
                    updateProgressStepper();
                    switchView();
                    // Announce new view title AFTER switch is complete
                    if (currentMode === 'accessible') {
                        speakText("Now on " + TEXTS[titleKey][currentLang]);
                    }
                };

                if (currentMode === 'accessible') {
                    event.preventDefault();
                    speakText(TEXTS.back[currentLang] + ". Going back to previous screen.", navigateBack);
                } else {
                    navigateBack();
                }
            }
        }
        
        function switchView() {
            // Hide all
            els.step1.classList.remove('active');
            els.step2.classList.remove('active');
            els.step3.classList.remove('active');

            // Show current
            if (currentStep === 1) els.step1.classList.add('active');
            if (currentStep === 2) {
                els.step2.classList.add('active');
                generateOffers(); 
            }
            if (currentStep === 3) {
                els.step3.classList.add('active');
                updateStep3Summary();
            }

            updateTexts();
            updateProgressStepper();
        }
        
        function updateProgressStepper() {
            const stepper = document.getElementById('progress-stepper');
            if (!stepper) return;
            
            // Ensure currentStep is valid
            if (currentStep < 1) currentStep = 1;
            if (currentStep > 3) currentStep = 3;
            
            const lang = currentLang;
            const indicators = stepper.querySelectorAll('.step-indicator');
            const totalSteps = 3;
            
            // Calculate progress percentage
            const progressPercent = ((currentStep - 1) / (totalSteps - 1)) * 100;
            stepper.style.setProperty('--progress-percent', progressPercent);
            
            indicators.forEach((indicator, index) => {
                const stepNum = index + 1;
                const label = indicator.querySelector('.step-label');
                
                // Update label text
                if (label && TEXTS[`stepLabel${stepNum}`]) {
                    label.textContent = TEXTS[`stepLabel${stepNum}`][lang];
                }
                
                // Update visual state - remove all state classes first
                indicator.classList.remove('active', 'completed');
                
                if (stepNum < currentStep) {
                    indicator.classList.add('completed');
                } else if (stepNum === currentStep) {
                    indicator.classList.add('active');
                }
            });
            
            // Update ARIA attributes
            stepper.setAttribute('aria-valuenow', currentStep);
            stepper.setAttribute('aria-valuetext', `Step ${currentStep} of ${totalSteps}`);
        }

        /* --- UTIL: UI UPDATES --- */
        function updateTexts() {
            const lang = currentLang;

            const titleKey = `title${currentStep}`;
            const appLogo = document.getElementById('app-logo');
            if (appLogo) {
                appLogo.src = lang === 'ur' ? 'logoUrdu.jpeg' : 'logo.png';
            }
            els.pageTitle.textContent = TEXTS[titleKey][lang];
            
            document.getElementById('txt-map').textContent = TEXTS.map[lang];
            document.getElementById('lbl-pickup').textContent = TEXTS.lblPickup[lang];
            document.getElementById('lbl-dropoff').textContent = TEXTS.lblDropoff[lang];
            document.getElementById('inp-dropoff').placeholder = TEXTS.phDropoff[lang];
            document.getElementById('lbl-cat-select').textContent = TEXTS.lblCat[lang];
            document.getElementById('lbl-recent').textContent = TEXTS.lblRecent[lang];
            els.btnNext1.textContent = TEXTS.btnNext[lang];

            if (currentStep === 2) {
                 document.getElementById('lbl-offers').textContent = TEXTS.lblOffers[lang];
                 document.getElementById('lbl-offers-sub').textContent = TEXTS.lblOffersSub[lang];
            }

            if (currentStep === 3) {
                 document.getElementById('lbl-summary').textContent = TEXTS.lblSummary[lang];
                 document.getElementById('lbl-vehicle').textContent = TEXTS.lblVehicle[lang];
                 document.getElementById('lbl-est-price').textContent = TEXTS.lblEstPrice[lang];
                 document.getElementById('lbl-payment').textContent = TEXTS.lblPayment[lang];
                 document.getElementById('pay-cash').textContent = TEXTS.payCash[lang];
                 document.getElementById('pay-wallet').textContent = TEXTS.payWallet[lang];
                 els.btnBook.textContent = TEXTS.btnBook[lang];
            }

            document.getElementById('modal-title').textContent = TEXTS.modalTitle[lang];
            document.getElementById('modal-msg').textContent = TEXTS.modalMsg[lang];
            document.getElementById('modal-ok').textContent = TEXTS.modalOk[lang];

            renderCategories();
            renderRecentLocations();
            
            els.inpPickup.dir = document.documentElement.dir;
            els.inpDropoff.dir = document.documentElement.dir;
            
            // Update progress stepper (for language changes)
            updateProgressStepper();
        }

        // Run
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>